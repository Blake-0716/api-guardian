events {}

http {
  upstream backend { server backend:5678; }
  upstream auth    { server auth:5000; }

  server {
    listen 8080;

    # 提示用
    location = / { return 200 "API Gateway is up\n"; }

    # 1) 登入：轉給 auth 服務
    location = /login {
      proxy_set_header Host $host;
      proxy_pass http://auth/login;
    }

    # 2) 驗證子請求：Nginx 用它檢查 Token（不對外）
    location = /__validate {
      internal;
      proxy_pass http://auth/validate;
      proxy_pass_request_body off;
      proxy_set_header Content-Length "";
      proxy_set_header Authorization $http_authorization;
    }

    # 3) 受保護的 API
    location /api/ {
      auth_request /__validate;                          # 驗證
      auth_request_set $user $upstream_http_x_user;      # 從驗證結果取使用者
      auth_request_set $role $upstream_http_x_role;

      proxy_set_header X-User $user;                     # 往後端轉傳（可用於日後記錄）
      proxy_set_header X-Role $role;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_pass http://backend;
    }
  }
}
